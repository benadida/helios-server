{% extends TEMPLATE_BASE %}
{% block title %}{{election.name}}{% endblock %}

{% block content %}
  {% if admin_p %}
    {% include "partials/election_progress.html" with current="view" election=election %}
  {% endif %}

  <div class="row">
    <div class="large-12 columns">
      <h2>
        {{ election.name }}
        {% if admin_p %}
          <small>[<a href="{% url 'helios.views.one_election_admin' election.uuid %}">Admin</a>]</small>
        {% endif %}
      </h2>

      <div class="row">
        {% if settings.SHOW_USER_INFO %}
          <div class="large-4 columns">
            <dl>
              <dt>Created by</dt>
              <dd>{{election.admin.display_html_small|safe}}</dd>
            </dl>
          </div>
        {% endif %}

        {% if election.voting_starts_at %}
          <div class="large-4 columns">
            <dl>
              <dt>Voting {% if election.voting_has_stopped %}Started{% else %}Starts{% endif %} at</dt>
              <dd>{{election.voting_starts_at}}</dd>
            </dl>
          </div>
        {% endif %}

        {% if election.voting_ends_at %}
          <div class="large-4 columns">
            <dl>
              <dt>Voting {% if election.voting_has_stopped %}Ended{% else %}Ends{% endif %} at</dt>
              <dd>{{election.voting_ends_at}}</dd>
            </dl>
          </div>
        {% endif %}
      </div>

      <div class="row">
        <div class="large-12 columns">
          {% if election.election_info_url or election.description %}
            <dl>
              {% if election.election_info_url %}
                <dt>Election Info</dt>
                <dd><a target="_blank" href="{{election.election_info_url}}">Candidate Bios and Statements</a></dd>
              {% endif %}

              {% if election.description %}
                <dt>Description</dt>
                <dd>{{election.description_bleached|safe}}</dd>
              {% endif %}
            </dl>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="large-12 columns">
      {% if election.result %}
        {% if election.result_released_at %}
          <div data-alert class="alert-box info">
            This election is complete.
          </div>
        {% endif %}

        {% if election.private_p %}
          <h3>Participation</h3>

          <p>
            {{num_voters_cast}} out of {{num_voters}} voters cast their vote, or {{participation_percentage}}%.
          </p>
        {% endif %}

        {% if election.result_released_at or election.result and admin_p %}
          <h3>Tally</h3>

          {% for question in election.pretty_result %}
            {% if forloop.counter0|divisibleby:2 %}<div class="row">{% endif %}
              <div class="large-6 columns">
                <h4>{{forloop.counter}}. {{question.question}}</h4>

                <table>
                  <thead>
                    <tr>
                      <td>
                        Answer
                      </td>
                      <td>
                        Count
                      </td>
                    </tr>
                  </thead>

                  <tbody>
                    {% for answer in question.answers %}
                      <tr>
                        <td style="padding-right:80px;{% if answer.winner %}font-weight: bold;{% endif %}">{{answer.answer}}</td>
                        <td align="right" style="{% if answer.winner %}font-weight: bold;{% endif %}">{{answer.count}}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% if not forloop.counter0|divisibleby:2 or forloop.last %}</div>{% endif %}
          {% endfor %}
        {% endif %}
      {% else %}
        {% if election.voting_has_stopped %}
          <div data-alert class="alert-box info">
            This election is closed. The tally will be computed soon.
          </div>
        {% else %}
          {% if election.voting_has_started %}
            <a class="button" href="{{test_cookie_url}}">Vote in This {{election.election_type|title}}</a>

            <div data-alert class="alert-box warning">
              {% if election.voting_extended_until %}
                This {{election.election_type}} was initially scheduled to end at {{election.voting_ends_at}}, but has been extended until {{ election.voting_extended_until }}.
              {% else %}
                {% if election.voting_ends_at %}
                  This {{election.election_type}} is scheduled to end at {{election.voting_ends_at}}.
                {% else %}
                  This {{election.election_type}} ends at the administrator's discretion.
                {% endif %}
              {% endif %}
            </div>

            {% if election.private_p and voter %}
              <p>This election is <b>private</b>. You are signed in as an eligible voter <i>{{voter.name}}</i>.</p>
            {% endif %}
          {% else %}
            <div data-alert class="alert-box warning">
              {% if election.voting_starts_at %}
                This {{election.election_type}} is scheduled to start at {{election.voting_starts_at}}.
              {% else %}
                Voting is not yet open.
              {% endif %}
            </div>
          {% endif %}

          {% if user %}
            {% if voter %}
              <p>
                You are registered to vote in this {{election.election_type}}. {% if election.use_voter_aliases %}Your voter alias is {{voter.alias}}.{% endif %}
              </p>
            {% else %}
              {% if not election.result %}
                <div data-alert class="alert-box info">
                  {% if election.openreg %}
                    {% if eligible_p %}
                      You are eligible to vote in this election.
                    {% else %}
                      You are <i>not eligible</i> to vote in this {{election.election_type}}.
                    {% endif %}
                  {% else %}
                    You are <i>not eligible</i> to vote in this {{election.election_type}}.
                  {% endif %}
                </div>
              {% endif %}
            {% endif %}
          {% else %}
            {% if election.openreg %}
              <div data-alert class="alert-box info">
                <b>Who can vote?</b>

                {% if election.eligibility %}
                  {{election.pretty_eligibility|safe}}
                {% else %}
                  Anyone can vote in this election.
                {% endif %}
              </div>
            {% endif %}
          {% endif %}
        {% endif %}
      {% endif %}

      <h3>Audit</h3>

      {% if election.frozen_at %}
        <a class="button" href="{% url 'helios.views.voters_list_pretty' election.uuid %}">Ballot Tracking Center</a>
        <a class="button" href="{% url 'helios.views.one_election_audited_ballots' election.uuid %}">Audited Ballots</a>

        {% if not election.voting_has_started %}
          <a class="button" href="{{SECURE_URL_HOST}}/booth/vote.html?election_url={% url 'helios.views.one_election' election.uuid %}">Preview Booth</a>
        {% endif %}
      {% endif %}

      {% if election.voting_has_stopped %}
        {% if election.result %}
          <a class="button" target="_blank" href="/verifier/verify.html?election_url={% url 'helios.views.one_election' election.uuid %}">Verify Election Tally</a>
        {% endif %}

        <a class="button" href="{{vote_url}}">Review the Voting Booth</a>
      {% endif %}

      <div class="panel callout">
        <dl class="no-margin">
          <dt>Election URL</dt>
          <dd><a href="{{election.url}}">{{election.url}}</a></dd>

          {% if election.frozen_at %}
            <dt>Election Fingerprint</dt>
            <dd><tt style="font-weight: bold;">{{election.hash}}</tt></dd>

            {% if votes %}
              <dt>Your Smart Ballot Tracker</dt>
              <dd><tt style="font-weight: bold;">{{votes.0.vote_hash}}</tt></dd>
            {% endif %}
          {% endif %}
        </dl>
      </div>
    </div>
  </div>
{% endblock %}
